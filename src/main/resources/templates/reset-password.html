<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restablecer Contraseña - TicketFlex</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        
        /* Estilos del logo - Posicionado en esquina superior izquierda */
        .logo-container {
            position: absolute;
            top: 1rem;
            left: 1rem;
            padding: 0.5rem 1rem;
        }
        
        .logo-text {
            text-decoration: none;
            font-size: 28px;
            font-weight: bold;
            font-family: 'Arial', sans-serif;
            color: #2b0a3d;
            transition: all 0.3s ease;
        }

        .logo-text span {
            color: #ff5e6c;
        }

        .logo-text:hover {
            opacity: 0.85;
        }

        /* Asegurar que el contenido principal no se superponga con el logo */
        .main-content {
            margin-top: 4rem;
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4 relative">

    <!-- Logo en la esquina superior izquierda -->
    <div class="logo-container">
        <a href="/" class="logo-text">Ticket<span>Flex</span></a>
    </div>

    <!-- Formulario de Reseteo -->
    <div class="w-full max-w-md bg-white rounded-xl shadow-lg p-8 space-y-6 main-content">
        <div class="text-center space-y-2">
            <h1 class="text-3xl font-bold text-gray-900">Restablecer Contraseña</h1>
            <p class="text-gray-500">Ingresa y confirma tu nueva contraseña.</p>
        </div>

        <form id="reset-form" class="space-y-4">
            <div>
                <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Nueva Contraseña</label>
                <input type="password" id="password" name="password" autocomplete="new-password" required
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-200"
                    minlength="6">
            </div>

            <div>
                <label for="confirm-password" class="block text-sm font-medium text-gray-700 mb-1">Confirmar
                    Contraseña</label>
                <input type="password" id="confirm-password" name="confirmPassword" autocomplete="new-password" required
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-200"
                    minlength="6">
            </div>

            <div id="message-container" class="mt-4 p-3 rounded-lg text-sm text-center font-medium hidden"></div>

            <button type="submit"
                class="w-full bg-indigo-600 text-white font-semibold py-2.5 px-4 rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-300">
                Restablecer Contraseña
            </button>
        </form>
    </div>

    <script>
        const form = document.getElementById('reset-form');
        const passwordInput = document.getElementById('password');
        const confirmPasswordInput = document.getElementById('confirm-password');
        const messageContainer = document.getElementById('message-container');

        // Función para mostrar mensajes de retroalimentación
        function showMessage(text, type) {
            messageContainer.textContent = text;
            messageContainer.classList.remove('hidden', 'bg-red-100', 'text-red-800', 'bg-green-100', 'text-green-800');
            if (type === 'success') {
                messageContainer.classList.add('bg-green-100', 'text-green-800');
            } else {
                messageContainer.classList.add('bg-red-100', 'text-red-800');
            }
            messageContainer.classList.remove('hidden');
        }

        // Obtener el token del PATH en lugar del query
        const pathParts = window.location.pathname.split('/');
        const token = pathParts[pathParts.length - 1];

        console.log('Token obtenido del path:', token);
        console.log('URL completa:', window.location.href);

        // Validar formato UUID del token
        const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;

        if (!token || !uuidRegex.test(token)) {
            showMessage('Token de restablecimiento inválido o faltante. Por favor, revisa el enlace.', 'error');
            console.error('Token inválido:', token);
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!token || !uuidRegex.test(token)) {
                showMessage('Token de restablecimiento inválido. Por favor, solicita un nuevo enlace.', 'error');
                return;
            }

            const password = passwordInput.value;
            const confirmPassword = confirmPasswordInput.value;

            // Validar que las contraseñas coincidan y cumplan la longitud
            if (password.length < 6) {
                showMessage('La contraseña debe tener al menos 6 caracteres.', 'error');
                return;
            }

            if (password !== confirmPassword) {
                showMessage('Las contraseñas no coinciden.', 'error');
                return;
            }

            try {
                // Enviar la solicitud POST al backend
                const response = await fetch('/api/usuarios/reset-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ token, newPassword: password })
                });

                const data = await response.json();

                if (response.ok) {
                    showMessage(data.message || 'Contraseña restablecida exitosamente. Redirigiendo a la pagina principal...', 'success');
                    // Redirigir al usuario a la página principal (index)
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 3000);
                } else {
                    showMessage(data.error || 'Error al restablecer la contraseña.', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showMessage('Ocurrió un error al conectar con el servidor. Inténtalo de nuevo más tarde.', 'error');
            }
        });

        // Limpiar el token de la URL SOLO si existe y es válido
        if (token && uuidRegex.test(token)) {
            // Crear URL sin el token pero mantener la página actual
            const newPath = window.location.pathname.split('/').slice(0, -1).join('/') || '/reset-password';
            window.history.replaceState({}, document.title, newPath);
        }
    </script>
</body>
</html>