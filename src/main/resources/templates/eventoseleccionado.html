<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>Evento Seleccionado - TicketFlex</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .evento-img {
            max-height: 300px;
            object-fit: cover;
        }

        .precio-total {
            font-size: 1.5rem;
            color: #28a745;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <div class="container py-5">
        <div class="row">
            <div class="col-md-6">
                <img th:src="@{'/images/' + ${evento.imagen}}" alt="Imagen del evento"
                    class="img-fluid rounded evento-img">
            </div>
            <div class="col-md-6">
                <h1 th:text="${evento.nombreEvento}"></h1>
                <p class="text-muted" th:text="${evento.descripcion}"></p>

                <div class="mb-3">
                    <span class="badge bg-primary" th:text="${evento.categoria}"></span>
                    <span class="badge bg-secondary ms-2" th:text="${evento.artista}"></span>
                </div>

                <p><strong>Fecha:</strong> <span th:text="${#temporals.format(evento.fecha, 'dd/MM/yyyy')}"></span></p>
                <p><strong>Lugar:</strong> <span th:text="${evento.lugar}"></span></p>
                <p><strong>Disponibilidad:</strong> <span th:text="${evento.disponibilidad}"></span> boletos</p>

                <hr>

                <h3>Comprar Boletos</h3>
                <form id="formCompra">
                    <input type="hidden" id="eventoId" th:value="${evento.id}">

                    <div class="mb-3">
                        <label class="form-label">Tipo de Boleto</label>
                        <select class="form-select" id="tipoBoleto" onchange="calcularTotal()">
                            <option value="BASE">General - $<span th:text="${evento.precioBase}"></span></option>
                            <option value="VIP">VIP - $<span th:text="${evento.precioVIP}"></span></option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Cantidad (máx. 5)</label>
                        <input type="number" class="form-control" id="cantidad" min="1" max="5" value="1"
                            onchange="calcularTotal()">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Precio Total</label>
                        <div class="precio-total" id="precioTotal"></div>
                    </div>

                    <button type="button" class="btn btn-primary w-100" onclick="comprarBoleto()">
                        Confirmar Compra
                    </button>
                </form>

                <div id="mensaje" class="mt-3"></div>
            </div>
        </div>
    </div>

    <!-- Modal Respuesta PayU -->
    <div class="modal fade" id="respuestaPayUModal" tabindex="-1" aria-labelledby="respuestaPayUModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="respuestaPayUModalLabel">Resultado del Pago</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                    <p><strong>Estado:</strong> <span id="estado"></span></p>
                    <p><strong>Referencia:</strong> <span id="referencia"></span></p>
                    <p><strong>Mensaje:</strong> <span id="mensajePayU"></span></p>
                    <p><strong>Método de Pago:</strong> <span id="metodoPago"></span></p>
                    <p><strong>ID Transacción:</strong> <span id="idTransaccion"></span></p>
                </div>
                <div class="modal-footer">
                    <a href="/" class="btn btn-primary">Regresar a Inicio</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Inyección de precios desde Thymeleaf -->
    <script>
        const precioBase = /*[[${evento.precioBase}]]*/ 0;
        const precioVIP = /*[[${evento.precioVIP}]]*/ 0;
    </script>

    <script>
        function calcularTotal() {
            const tipo = $('#tipoBoleto').val();
            const cantidad = parseInt($('#cantidad').val());

            const precio = tipo === 'VIP' ? precioVIP : precioBase;
            const total = (precio * cantidad).toFixed(2);

            $('#precioTotal').text('$' + total);
        }

        function comprarBoleto() {
            const eventoId = $('#eventoId').val();
            const cantidad = parseInt($('#cantidad').val());
            const tipoBoleto = $('#tipoBoleto').val();

            if (cantidad < 1 || cantidad > 5) {
                $('#mensaje').html('<div class="alert alert-warning">La cantidad debe estar entre 1 y 5.</div>');
                return;
            }

            fetch(`/api/eventos/${eventoId}/comprar`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ cantidad, tipoBoleto })
            })
                .then(response => response.text())
                .then(html => {
                    // Crear una nueva ventana o reemplazar el body con el HTML de redirección a PayU
                    const nuevaVentana = window.open('', '_blank');
                    nuevaVentana.document.write(html);
                    nuevaVentana.document.close();
                })
                .catch(error => {
                    $('#mensaje').html(`<div class="alert alert-danger">Error: ${error}</div>`);
                });
        }

        $(document).ready(function () {
            calcularTotal();

            const urlParams = new URLSearchParams(window.location.search);
            const estado = urlParams.get('state');
            const referencia = urlParams.get('referenceCode');
            const mensaje = urlParams.get('message');
            const metodoPago = urlParams.get('lapPaymentMethod');
            const idTransaccion = urlParams.get('transactionId');

            if (estado || referencia || mensaje || metodoPago || idTransaccion) {
                $('#estado').text(estado ?? '-');
                $('#referencia').text(referencia ?? '-');
                $('#mensajePayU').text(mensaje ?? '-');
                $('#metodoPago').text(metodoPago ?? '-');
                $('#idTransaccion').text(idTransaccion ?? '-');

                var modal = new bootstrap.Modal(document.getElementById('respuestaPayUModal'));
                modal.show();
            }
        });
    </script>

</body>

</html>